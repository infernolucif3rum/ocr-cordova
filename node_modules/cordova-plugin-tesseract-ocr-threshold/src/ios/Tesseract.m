//
//  Tesseract.m
//
//  Created by Julio Cesar Sanchez Hernandez on 3/11/16.
//
//

#import "Tesseract.h"

@implementation Tesseract

- (void) recognise:(CDVInvokedUrlCommand *)command {
    
    NSString * image_url = [command argumentAtIndex:0];
    
    NSURL *url = [NSURL URLWithString:image_url];
    NSData *data = [NSData dataWithContentsOfURL:url];
    UIImage *image = [[UIImage alloc] initWithData:data];
    
    G8RecognitionOperation *operation = [[G8RecognitionOperation alloc] initWithLanguage:@"eng"];

    // THRESOLD 
    // Grab the image you want to preprocess
    UIImage *inputImage = [UIImage imageNamed:@"my_test_image.jpg"];

    // Initialize our adaptive threshold filter
    GPUImageAdaptiveThresholdFilter *stillImageFilter = [[GPUImageAdaptiveThresholdFilter alloc] init];
    stillImageFilter.blurRadiusInPixels = 4.0 // adjust this to tweak the blur radius of the filter, defaults to 4.0

    // Retrieve the filtered image from the filter
    UIImage *filteredImage = [stillImageFilter imageByFilteringImage:inputImage];
    // THRESOLD END

    
    operation.tesseract.image = [filteredImage g8_blackAndWhite];
    
    operation.recognitionCompleteBlock = ^(G8Tesseract *recognizedTesseract) {
        CDVPluginResult * result = [CDVPluginResult resultWithStatus:CDVCommandStatus_OK messageAsString:[recognizedTesseract recognizedText]];
        [self.commandDelegate sendPluginResult:result callbackId:command.callbackId];
    };

    NSOperationQueue *queue = [[NSOperationQueue alloc] init];
    [queue addOperation:operation];
}

@end
